module "simphera_instance" {
  source                       = "./modules/simphera_aws_instance"
  for_each                     = var.simpheraInstances
  backup_retention             = each.value.backup_retention
  cloudwatch_retention         = var.cloudwatch_retention
  db_instance_type_keycloak    = each.value.db_instance_type_keycloak
  db_instance_type_simphera    = each.value.db_instance_type_simphera
  eks_oidc_issuer_url          = module.eks.eks_oidc_issuer_url
  eks_oidc_provider_arn        = module.eks.eks_oidc_provider_arn
  enable_backup_service        = each.value.enable_backup_service
  enable_deletion_protection   = each.value.enable_deletion_protection
  enableKeycloak               = each.value.enable_keycloak
  infrastructurename           = local.infrastructurename
  k8s_namespace                = each.value.k8s_namespace
  kms_key_cloudwatch           = aws_kms_key.kms_key_cloudwatch_log_group.arn
  log_bucket                   = aws_s3_bucket.bucket_logs.id
  name                         = each.value.name
  postgresql_security_group_id = module.security_group.security_group_id
  postgresqlApplyImmediately   = each.value.postgresqlApplyImmediately
  postgresqlMaxStorage         = each.value.postgresqlMaxStorage
  postgresqlMaxStorageKeycloak = each.value.postgresqlMaxStorageKeycloak
  postgresqlStorage            = each.value.postgresqlStorage
  postgresqlStorageKeycloak    = each.value.postgresqlStorageKeycloak
  postgresqlVersion            = each.value.postgresqlVersion
  private_subnets              = local.private_subnets
  region                       = local.region
  secretname                   = each.value.secretname
  tags                         = var.tags
  depends_on                   = [module.eks, kubernetes_storage_class_v1.efs]
}
